# Hodor AI Code Review for GitLab CI
#
# This GitLab CI configuration automatically reviews merge requests using Hodor.
# Hodor provides automated, READ-ONLY code analysis using grep, glob, and intelligent file reading.
#
# Setup Instructions:
# 1. Copy this file to `.gitlab-ci.yml` in your repository
# 2. Set CI/CD variables in GitLab Settings > CI/CD > Variables:
#    - LLM_API_KEY (or ANTHROPIC_API_KEY): Your Claude API key
#    - GITLAB_TOKEN: GitLab access token with api scope (for posting comments)
# 3. (Optional) Set GITLAB_HOST if using self-hosted GitLab
#
# The review will:
# - Run automatically on merge requests
# - Post review comments directly to the MR
# - Use efficient grep/glob tools for fast analysis
# - Check for bugs, security issues, and performance problems

# Define when to run (on merge request pipelines)
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Hodor review job
hodor-review:
  image: python:3.13-slim
  stage: test

  variables:
    # Model configuration (can be overridden in CI/CD variables)
    LLM_MODEL: "anthropic/claude-sonnet-4-5-20250929"
    # Set to "true" to enable verbose logging
    HODOR_VERBOSE: "false"

  before_script:
    # Install system dependencies
    - apt-get update && apt-get install -y git curl

    # Install GitLab CLI (glab)
    - curl -fsSL https://gitlab.com/gitlab-org/cli/-/releases/permalink/latest/downloads/glab_linux_amd64.deb -o /tmp/glab.deb
    - dpkg -i /tmp/glab.deb || apt-get install -f -y

    # Install uv (fast Python package installer)
    - curl -LsSf https://astral.sh/uv/install.sh | sh
    - export PATH="$HOME/.local/bin:$PATH"

    # Verify glab authentication
    - glab auth status || echo "Warning: glab not authenticated. Set GITLAB_TOKEN in CI/CD variables."

  script:
    # Clone Hodor (use specific version tag for production)
    - git clone https://github.com/mr-karan/hodor /tmp/hodor
    - cd /tmp/hodor
    # Uncomment to use a specific version:
    # - git checkout v1.0.0

    # Install Hodor dependencies
    - uv sync

    # Build MR URL
    - export MR_URL="${CI_MERGE_REQUEST_PROJECT_URL}/-/merge_requests/${CI_MERGE_REQUEST_IID}"
    - echo "Reviewing MR: $MR_URL"

    # Run Hodor review with automatic posting
    - |
      if [ "$HODOR_VERBOSE" = "true" ]; then
        uv run hodor "$MR_URL" --model "$LLM_MODEL" --post --verbose
      else
        uv run hodor "$MR_URL" --model "$LLM_MODEL" --post
      fi

  # Only run on merge requests
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

  # Allow failure so MR isn't blocked if review fails
  allow_failure: true

  # Capture logs for debugging
  artifacts:
    when: always
    paths:
      - /tmp/hodor/*.log
    expire_in: 7 days

# Optional: Run only on specific labels or keywords
# Uncomment and modify as needed:
#
# hodor-review-on-label:
#   extends: hodor-review
#   rules:
#     - if: $CI_MERGE_REQUEST_LABELS =~ /hodor-review/

# Optional: Use different models for different projects
# Add in CI/CD variables or override here:
#
# variables:
#   LLM_MODEL: "anthropic/claude-opus-4"  # For thorough reviews
#   # LLM_MODEL: "anthropic/claude-sonnet-4-5-20250929"  # Balanced (default)
#   # LLM_MODEL: "openai/gpt-4"  # Alternative provider
